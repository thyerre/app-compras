<div class="form-page px-4 ">
  <div class="mb-4">
    <h1 class="text-xl font-semibold text-gray-800 m-0">{{ isEditMode() ? 'Editar Processo' : 'Novo Processo de Compra' }}</h1>
  </div>

  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="flex flex-col gap-4">

    <!-- Dados do Processo -->
    <div class="bg-white rounded-lg border border-gray-200 p-5">
      <div class="flex items-center gap-2 mb-4">
        <mat-icon class="text-gray-500">gavel</mat-icon>
        <h2 class="text-base font-semibold text-gray-700 m-0">Dados do Processo</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <app-input label="Nº Processo" formControlName="numeroProcesso" [errorMessage]="getError('numeroProcesso')"></app-input>
        <app-input label="Exercício" type="number" formControlName="exercicio" [errorMessage]="getError('exercicio')"></app-input>
        <app-input label="Nº Edital" formControlName="numeroEdital"></app-input>
        <app-input label="Ano Edital" type="number" formControlName="anoEdital"></app-input>
        <div class="lg:col-span-4 md:col-span-2">
          <app-input label="Objeto" formControlName="objeto" [errorMessage]="getError('objeto')"></app-input>
        </div>
        <div class="lg:col-span-4 md:col-span-2">
          <app-input label="Justificativa" formControlName="justificativa"></app-input>
        </div>
      </div>
    </div>

    <!-- Classificação -->
    <div class="bg-white rounded-lg border border-gray-200 p-5">
      <div class="flex items-center gap-2 mb-4">
        <mat-icon class="text-gray-500">category</mat-icon>
        <h2 class="text-base font-semibold text-gray-700 m-0">Classificação</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="lg:col-span-2">
          <app-select label="Modalidade" formControlName="modalidadeId" [options]="modalidadesOptions()" [errorMessage]="getError('modalidadeId')"></app-select>
        </div>
        <app-select label="Tipo de Julgamento" formControlName="tipoJulgamentoId" [options]="tiposJulgamentoOptions()"></app-select>
        <app-select label="Status" formControlName="statusId" [options]="statusOptions()" [errorMessage]="getError('statusId')"></app-select>
        <app-select label="Órgão" formControlName="orgaoId" [options]="orgaosOptions()" [errorMessage]="getError('orgaoId')" (valueChange)="onOrgaoChange($event)"></app-select>
        <app-select label="Unidade" formControlName="unidadeId" [options]="unidadesOptions()"></app-select>
      </div>
    </div>

    <!-- Valores e Datas -->
    <div class="bg-white rounded-lg border border-gray-200 p-5">
      <div class="flex items-center gap-2 mb-4">
        <mat-icon class="text-gray-500">event</mat-icon>
        <h2 class="text-base font-semibold text-gray-700 m-0">Valores e Datas</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <app-input label="Valor Estimado" type="number" formControlName="valorEstimado"></app-input>
        <app-input label="Valor Homologado" type="number" formControlName="valorHomologado"></app-input>
        <app-datepicker label="Data de Abertura" formControlName="dataAbertura"></app-datepicker>
        <app-datepicker label="Data de Encerramento" formControlName="dataEncerramento"></app-datepicker>
        <app-datepicker label="Data de Homologação" formControlName="dataHomologacao"></app-datepicker>
        <app-datepicker label="Data de Publicação" formControlName="dataPublicacao"></app-datepicker>
      </div>
    </div>

    <!-- Itens do Processo -->
    <div class="bg-white rounded-lg border border-gray-200 p-5">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <mat-icon class="text-gray-500">list_alt</mat-icon>
          <h2 class="text-base font-semibold text-gray-700 m-0">Itens do Processo</h2>
        </div>
        <button mat-icon-button color="primary" type="button" (click)="addItem()">
          <mat-icon>add_circle</mat-icon>
        </button>
      </div>
      @if (itens.length === 0) {
        <p class="text-gray-400 italic text-center py-4">Nenhum item cadastrado. Clique no botão + para adicionar.</p>
      }
      @for (item of itens.controls; track $index; let i = $index) {
        <div class="mb-4" [formGroupName]="'itens'">
          <div [formGroupName]="i" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 items-start">
            <app-input label="Nº Item" type="number" formControlName="numeroItem"></app-input>
            <div class="lg:col-span-2">
              <app-input label="Descrição" formControlName="descricao"></app-input>
            </div>
            <app-input label="Unidade" formControlName="unidade"></app-input>
            <app-input label="Quantidade" type="number" formControlName="quantidade"></app-input>
            <div class="flex items-center gap-2">
              <div class="flex-1">
                <app-input label="Valor Unit." type="number" formControlName="valorUnitarioEstimado"></app-input>
              </div>
              <button mat-icon-button color="warn" type="button" (click)="removeItem(i)" class="mt-3">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
          @if (!$last) {
            <mat-divider class="my-3"></mat-divider>
          }
        </div>
      }
    </div>

    <!-- Observações -->
    <div class="bg-white rounded-lg border border-gray-200 p-5">
      <div class="flex items-center gap-2 mb-4">
        <mat-icon class="text-gray-500">notes</mat-icon>
        <h2 class="text-base font-semibold text-gray-700 m-0">Observações</h2>
      </div>
      <app-input label="Observações" formControlName="observacoes"></app-input>
    </div>

    <div class="flex justify-end gap-3 py-4">
      <app-button label="Cancelar" variant="stroked" type="button" (clicked)="onCancel()"></app-button>
      <app-button label="Salvar" variant="raised" color="primary" type="submit" [disabled]="saving()"></app-button>
    </div>
  </form>
</div>
